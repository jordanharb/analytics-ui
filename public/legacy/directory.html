<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Directory - TPUSA Social Monitoring</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 10px;
            padding: 30px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }

        h1 {
            color: #333;
            margin-bottom: 30px;
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .filters-container {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 25px;
        }

        .type-filters {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-bottom: 20px;
        }

        .type-btn {
            padding: 8px 20px;
            border: 2px solid #ddd;
            background: white;
            border-radius: 25px;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 500;
        }

        .type-btn:hover {
            background: #f0f0f0;
        }

        .type-btn.active {
            background: #4facfe;
            color: white;
            border-color: #4facfe;
        }

        .search-container {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }

        .search-input {
            flex: 1;
            padding: 10px 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s;
        }

        .btn-primary {
            background: #4facfe;
            color: white;
        }

        .btn-primary:hover {
            background: #3d9be9;
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn-secondary:hover {
            background: #5a6268;
        }

        .advanced-search {
            display: none;
            background: white;
            padding: 15px;
            border-radius: 5px;
            margin-top: 15px;
            border: 1px solid #e0e0e0;
        }

        .advanced-search.show {
            display: block;
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 10px;
            margin-bottom: 15px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
        }

        .form-group label {
            font-size: 12px;
            color: #666;
            margin-bottom: 3px;
        }

        .form-group input, .form-group select {
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }

        .directory-table {
            width: 100%;
            border-collapse: collapse;
        }

        .directory-table thead {
            background: #f8f9fa;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .directory-table th {
            padding: 12px;
            text-align: left;
            font-weight: 600;
            color: #495057;
            border-bottom: 2px solid #dee2e6;
            cursor: pointer;
            user-select: none;
        }

        .directory-table th:hover {
            background: #e9ecef;
        }

        .directory-table tbody tr {
            cursor: pointer;
            transition: background 0.2s;
        }

        .directory-table tbody tr:hover {
            background: #f8f9fa;
        }

        .directory-table td {
            padding: 12px;
            border-bottom: 1px solid #dee2e6;
        }

        .type-badge {
            display: inline-block;
            padding: 3px 10px;
            border-radius: 15px;
            font-size: 12px;
            font-weight: 500;
            text-transform: capitalize;
        }
        
        /* View Toggle Styles */
        .view-toggle {
            display: flex;
            gap: 8px;
            margin-bottom: 20px;
            background: white;
            padding: 8px;
            border-radius: 8px;
            border: 1px solid #e0e0e0;
        }
        
        .view-btn {
            padding: 8px 16px;
            border: 1px solid #ddd;
            background: white;
            color: #666;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        
        .view-btn:hover {
            background: #f8f9fa;
        }
        
        .view-btn.active {
            background: #4facfe;
            color: white;
            border-color: #4facfe;
        }
        
        /* Cards Layout Styles */
        .directory-cards {
            display: none;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
            padding: 20px 0;
        }
        
        .directory-cards.active {
            display: grid;
        }
        
        .directory-table.hidden {
            display: none;
        }
        
        .actor-card {
            background: white;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            padding: 20px;
            transition: all 0.3s ease;
            cursor: pointer;
            border: 1px solid #e9ecef;
            position: relative;
            overflow: hidden;
        }
        
        .actor-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 6px 20px rgba(0,0,0,0.12);
            border-color: #4facfe;
        }
        
        .actor-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, #4facfe 0%, #00f2fe 100%);
            transform: scaleX(0);
            transition: transform 0.3s ease;
        }
        
        .actor-card:hover::before {
            transform: scaleX(1);
        }
        
        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 16px;
        }
        
        .actor-avatar {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 24px;
            font-weight: 600;
            flex-shrink: 0;
        }
        
        .actor-type-badge {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .actor-type-badge.person {
            background: #e3f2fd;
            color: #1976d2;
        }
        
        .actor-type-badge.organization {
            background: #f3e5f5;
            color: #7b1fa2;
        }
        
        .actor-type-badge.chapter {
            background: #e8f5e9;
            color: #388e3c;
        }
        
        .actor-type-badge.unknown {
            background: #fafafa;
            color: #757575;
        }
        
        .card-body {
            margin-bottom: 16px;
        }
        
        .card-body h3 {
            font-size: 18px;
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 8px;
            line-height: 1.3;
        }
        
        .card-location {
            display: flex;
            align-items: center;
            gap: 4px;
            color: #666;
            font-size: 14px;
            margin-bottom: 12px;
        }
        
        .card-stats {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            padding: 12px 0;
            border-top: 1px solid #e9ecef;
            border-bottom: 1px solid #e9ecef;
            margin-bottom: 16px;
        }
        
        .stat-item {
            text-align: center;
        }
        
        .stat-value {
            font-size: 20px;
            font-weight: 600;
            color: #4facfe;
            display: block;
        }
        
        .stat-label {
            font-size: 12px;
            color: #999;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-top: 4px;
        }
        
        .card-actions {
            display: flex;
            gap: 8px;
        }
        
        .card-btn {
            flex: 1;
            padding: 10px;
            border: 1px solid #e0e0e0;
            background: white;
            color: #495057;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            text-align: center;
        }
        
        .card-btn:hover {
            background: #4facfe;
            color: white;
            border-color: #4facfe;
        }
        
        .card-btn.primary {
            background: #4facfe;
            color: white;
            border-color: #4facfe;
        }
        
        .card-btn.primary:hover {
            background: #3d9be9;
        }
        
        /* Mobile Responsive Cards */
        @media (max-width: 768px) {
            .directory-cards {
                grid-template-columns: 1fr;
                padding: 10px;
                gap: 15px;
            }
            
            .actor-card {
                padding: 16px;
            }
            
            .view-toggle {
                justify-content: center;
            }
            
            .view-btn {
                flex: 1;
            }
        }
        
        @media (max-width: 480px) {
            .card-stats {
                grid-template-columns: 1fr;
                gap: 8px;
            }
            
            .actor-avatar {
                width: 48px;
                height: 48px;
                font-size: 20px;
            }
        }

        .type-badge.person {
            background: #e3f2fd;
            color: #1976d2;
        }

        .type-badge.organization {
            background: #f3e5f5;
            color: #7b1fa2;
        }

        .type-badge.chapter {
            background: #e8f5e9;
            color: #388e3c;
        }

        .loading-container {
            text-align: center;
            padding: 40px;
        }

        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #4facfe;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .load-more-container {
            text-align: center;
            padding: 20px;
        }

        .stats-container {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
        }

        .stat-card {
            flex: 1;
            background: white;
            padding: 15px;
            border-radius: 8px;
            border: 1px solid #e0e0e0;
            text-align: center;
        }

        .stat-card .number {
            font-size: 28px;
            font-weight: bold;
            color: #4facfe;
        }

        .stat-card .label {
            font-size: 14px;
            color: #666;
            margin-top: 5px;
        }

        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            overflow-y: auto;
        }

        .modal.show {
            display: block;
        }

        .modal-content {
            background: white;
            width: 90%;
            max-width: 900px;
            margin: 50px auto;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
        }

        .modal-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-header h2 {
            margin: 0;
            font-size: 24px;
        }

        .close-btn {
            background: none;
            border: none;
            color: white;
            font-size: 28px;
            cursor: pointer;
            padding: 0;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .close-btn:hover {
            opacity: 0.8;
        }

        .modal-body {
            padding: 20px;
            max-height: 70vh;
            overflow-y: auto;
        }

        .detail-section {
            margin-bottom: 25px;
            padding-bottom: 20px;
            border-bottom: 1px solid #e0e0e0;
        }

        .detail-section:last-child {
            border-bottom: none;
        }

        .detail-section h3 {
            color: #333;
            margin-bottom: 15px;
            font-size: 18px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .detail-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
        }

        .detail-item {
            display: flex;
            flex-direction: column;
        }

        .detail-label {
            font-size: 12px;
            color: #666;
            margin-bottom: 3px;
            font-weight: 600;
        }

        .detail-value {
            font-size: 14px;
            color: #333;
        }

        .events-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 14px;
        }

        .events-table th {
            background: #f8f9fa;
            padding: 10px;
            text-align: left;
            font-weight: 600;
            border-bottom: 2px solid #dee2e6;
        }

        .events-table td {
            padding: 10px;
            border-bottom: 1px solid #dee2e6;
        }

        .export-buttons {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
            margin-top: 20px;
        }

        .no-results {
            text-align: center;
            padding: 40px;
            color: #666;
        }

        .back-link {
            display: inline-block;
            margin-bottom: 20px;
            color: #4facfe;
            text-decoration: none;
            font-weight: 500;
        }

        .back-link:hover {
            text-decoration: underline;
        }

        /* Enhanced Actor Modal Styles (from Analytics) */
        .actor-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: white;
            z-index: 10000;
            display: block;
            overflow-y: auto;
        }
        
        .actor-modal-content {
            background: white;
            width: 100%;
            min-height: 100vh;
            border-radius: 0;
            box-shadow: none;
            display: flex;
            flex-direction: column;
            overflow: visible;
        }
        
        .actor-modal-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 16px 24px;
            position: sticky;
            top: 0;
            z-index: 100;
            flex-shrink: 0;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .actor-modal-close {
            position: absolute;
            top: 15px;
            right: 15px;
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            font-size: 24px;
            cursor: pointer;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: all 0.2s ease;
        }
        
        .actor-modal-close:hover {
            background: rgba(255, 255, 255, 0.3);
        }
        
        .actor-header-info {
            display: flex;
            align-items: baseline;
            gap: 12px;
            margin-bottom: 12px;
        }
        
        .actor-modal-header .actor-name {
            margin: 0;
            font-size: 24px;
            font-weight: 600;
            color: white;
        }
        
        .kpi-bar {
            display: flex;
            align-items: center;
            gap: 14px;
            flex-wrap: wrap;
            font-size: 13px;
            color: #fff;
            opacity: 0.95;
        }

        .kpi {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 4px 8px;
            border-radius: 999px;
            background: rgba(255,255,255,0.12);
            border: 1px solid rgba(255,255,255,0.18);
            backdrop-filter: blur(2px);
            white-space: nowrap;
        }

        .kpi strong { font-weight: 700; color: #fff; }
        .kpi .muted { opacity: 0.85; font-weight: 500; }
        
        .actor-modal-body {
            flex: 1;
            overflow-y: auto;
            padding: 40px 20px;
            background: #f8f9fa;
        }
        
        .actor-modal-body > div {
            max-width: 1400px;
            margin: 0 auto;
        }
        
        .actor-info-section {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 20px;
            border-left: 4px solid #667eea;
            margin-bottom: 20px;
        }
        
        .full-width-section {
            grid-column: 1 / -1;
        }
        
        .section-title {
            font-size: 16px;
            font-weight: 600;
            color: #2c3e50;
            margin: 0 0 16px 0;
            border-bottom: 1px solid #e9ecef;
            padding-bottom: 6px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .section-icon {
            width: 18px;
            height: 18px;
            opacity: 0.7;
        }
        
        .field-group {
            display: grid;
            gap: 12px;
        }
        
        .field {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            padding: 8px 0;
            border-bottom: 1px solid #e9ecef;
        }
        
        .field:last-child {
            border-bottom: none;
        }
        
        .field-label {
            font-weight: 500;
            color: #6c757d;
            font-size: 14px;
            min-width: 120px;
            flex-shrink: 0;
        }
        
        .field-value {
            color: #2c3e50;
            font-size: 14px;
            text-align: right;
            word-break: break-word;
            flex: 1;
        }
        
        .social-link {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            background: #e3f2fd;
            color: #1976d2;
            padding: 6px 12px;
            border-radius: 20px;
            text-decoration: none;
            font-size: 12px;
            transition: all 0.2s;
            margin-right: 8px;
            margin-bottom: 8px;
        }
        
        .social-link:hover {
            background: #bbdefb;
            transform: translateY(-1px);
        }
        
        .actor-events-controls {
            display: flex;
            gap: 12px;
            align-items: center;
            margin-bottom: 20px;
            padding: 12px;
            background: #f8f9fa;
            border-radius: 8px;
        }
        
        .actor-search-input {
            flex: 1;
            min-width: 200px;
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
        }
        
        .actor-page-size-controls {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
        }
        
        .actor-page-size-controls select {
            padding: 6px 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }
        
        .actor-export-dropdown {
            position: relative;
        }
        
        .actor-export-button {
            padding: 8px 16px;
            background: #4facfe;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.2s;
        }
        
        .actor-export-button:hover {
            background: #3d9be9;
        }
        
        .actor-export-menu {
            position: absolute;
            top: 100%;
            right: 0;
            margin-top: 4px;
            background: white;
            border: 1px solid #ddd;
            border-radius: 6px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            z-index: 1000;
        }
        
        .actor-export-menu button {
            display: block;
            width: 100%;
            padding: 10px 16px;
            background: none;
            border: none;
            text-align: left;
            cursor: pointer;
            font-size: 14px;
            white-space: nowrap;
            transition: background 0.2s;
        }
        
        .actor-export-menu button:hover {
            background: #f0f0f0;
        }
        
        .actor-events-section h3 {
            margin: 0 0 16px 0;
            font-size: 18px;
            color: #333;
        }
        
        .actor-events-list {
            background: white;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            padding: 16px;
            min-height: 200px;
        }

        .event-item {
            padding: 12px;
            margin-bottom: 12px;
            background: #f8f9fa;
            border-radius: 6px;
            border-left: 3px solid #4facfe;
            transition: all 0.2s;
        }

        .actor-events-list.compact .event-item { padding: 8px; }
        
        .clickable-event:hover {
            background: #e9ecef;
            transform: translateX(2px);
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .clickable-event.expanded {
            background: #e3f2fd;
            border-left-color: #2196f3;
        }
        
        .actor-members-section {
            margin-bottom: 20px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 8px;
        }
        
        .actor-members-list {
            background: white;
            border-radius: 6px;
            padding: 10px;
            margin-top: 10px;
        }
        
        .member-row:hover {
            background: #f0f8ff !important;
        }
        
        .event-item:hover {
            background: #e9ecef;
            transform: translateX(2px);
        }
        
        .event-date {
            font-weight: 600;
            color: #4facfe;
            font-size: 13px;
            margin-bottom: 4px;
        }

        .coverage-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(70px, 1fr));
            gap: 8px;
        }

        .state-chip {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            padding: 0 8px;
            border-radius: 999px;
            border: 1px solid #e1e4ea;
            background: #fff;
            font-size: 11px;
            color: #2c3e50;
            cursor: pointer;
            user-select: none;
            transition: all .15s;
        }

        .state-chip:hover { background: #f6f8fb; }
        .state-chip.active {
            background: #e8f1ff;
            border-color: #4facfe;
            color: #0b57d0;
            box-shadow: 0 0 0 2px rgba(79,172,254,0.10) inset;
        }
        .state-code { font-weight: 700; letter-spacing: .4px; }
        .state-count { opacity: .8; }
        
        .event-name {
            font-weight: 500;
            color: #333;
            margin-bottom: 4px;
        }
        
        .event-location {
            color: #666;
            font-size: 13px;
        }
        
        .actor-pagination {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 8px;
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid #e0e0e0;
        }
        
        .actor-pagination button {
            padding: 6px 12px;
            background: white;
            border: 1px solid #ddd;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s;
        }
        
        .actor-pagination button:hover:not(:disabled) {
            background: #f0f0f0;
            border-color: #4facfe;
        }
        
        .actor-pagination button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .actor-pagination button.active {
            background: #4facfe;
            color: white;
            border-color: #4facfe;
        }
        
        .actor-relationships-container {
            display: grid;
            gap: 12px;
        }
        
        .relationship-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 10px;
            background: white;
            border: 1px solid #e0e0e0;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .relationship-item:hover {
            background: #f8f9fa;
            border-color: #4facfe;
        }
        
        .relationship-type {
            font-size: 12px;
            color: #666;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .relationship-name {
            font-weight: 500;
            color: #333;
        }
        
        .relationship-badge {
            background: #e3f2fd;
            color: #1976d2;
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 11px;
        }
        
        @media (max-width: 768px) {
            .actor-modal-content {
                width: 95%;
                height: 95vh;
            }
            
            .actor-events-controls {
                flex-direction: column;
                align-items: stretch;
            }
            
            .actor-search-input {
                min-width: auto;
            }
        }

        :root{
          --brand: #5b7cff;          /* tune to your purple */
          --ink-900:#0f172a; --ink-600:#475569; --ink-400:#94a3b8;
          --line:#e5e7eb; --card:#ffffff; --bg:#f7f8fb;
          --radius:14px;
        }

        /* PAGE LAYOUT */
        .actor-modal-body {
          background: var(--bg);
          padding: 12px 16px 24px;
        }
        .actor-content {
          max-width: 1120px;
          margin: 0 auto;
        }

        /* HEADER + BACK BUTTON */
        .actor-modal-header{
          position: sticky; top: 0; z-index: 8;
          background: linear-gradient(180deg, var(--brand), #7d8dff);
          padding: 14px 16px 12px;
          color: #fff; border-bottom-left-radius: var(--radius); border-bottom-right-radius: var(--radius);
          box-shadow: 0 2px 10px rgba(17,24,39,.15);
        }
        .header-row{
          display: flex; align-items: center; gap: 12px; flex-wrap: wrap;
        }
        .btn-back{
          display: inline-flex; align-items: center; gap: 6px;
          padding: 6px 10px; border-radius: 999px; border: 1px solid rgba(255,255,255,0.25);
          background: rgba(255,255,255,0.12); color: #fff; cursor: pointer;
          font-size: 13px; line-height: 1; white-space: nowrap;
        }
        .btn-back:hover{ background: rgba(255,255,255,0.2); }

        /* NAME + TYPE CHIP */
        .actor-name{ font-size: 20px; font-weight: 700; letter-spacing: .2px; }
        .type-chip{
          display:inline-flex; align-items:center; gap:6px;
          padding: 4px 8px; border-radius: 999px; background: rgba(255,255,255,0.14); border:1px solid rgba(255,255,255,0.25);
          font-size: 12px;
        }

        /* KPI BAR */
        .kpi-bar { display:flex; align-items:center; gap:10px; flex-wrap:wrap; margin-top:8px; }
        .kpi { display:inline-flex; align-items:center; gap:6px; padding:4px 8px; border-radius:999px; background:rgba(255,255,255,0.12); border:1px solid rgba(255,255,255,0.2); font-size:12px; }
        .kpi strong{ font-weight:700; }

        /* SECTION CARDS */
        .section-card{
          background: var(--card);
          border:1px solid var(--line);
          border-radius: var(--radius);
          padding: 16px;
          margin-top: 14px;
          box-shadow: 0 1px 2px rgba(15,23,42,.06);
        }

        /* TWO-COLUMN CONTENT GRID (desktop) */
        .content-grid{
          display:grid;
          grid-template-columns: 360px 1fr;
          gap: 16px;
        }
        @media (max-width: 1100px){
          .content-grid{ grid-template-columns: 1fr; }
        }

        /* INFO GRID */
        .info-grid{
          display: grid;
          grid-template-columns: 140px 1fr;
          row-gap: 10px; column-gap: 12px;
        }
        .info-grid dt{
          color: var(--ink-600);
          font-weight: 600;
          font-size: 12px; text-transform: uppercase; letter-spacing: .4px;
          align-self: start; padding-top: 3px;
        }
        .info-grid dd{ color: var(--ink-900); margin: 0; }

        /* DESCRIPTION truncation */
        .info-grid .desc{
          max-height: 3.6em; overflow: hidden; position: relative;
        }
        .info-grid .desc.expanded{ max-height: none; }

        /* COVERAGE GRID */
        .coverage-grid{
          display: grid;
          grid-auto-rows: 30px;
          grid-template-columns: repeat(auto-fill, minmax(72px, max-content));
          gap: 6px;
          justify-content: start;
        }
        
        /* Twitter embed specific styles */
        .twitter-embed-container {
            position: relative;
            margin-bottom: 10px;
        }
        
        .twitter-tweet {
            margin: 0 !important;
        }
        
        /* Fallback styles for failed Twitter embeds */
        .tweet-fallback {
            background: #f7f9fa;
            border: 1px solid #cfd9de;
            border-radius: 12px;
            padding: 12px !important;
            position: relative;
        }
        
        .tweet-fallback::before {
            content: "𝕏";
            position: absolute;
            top: 12px;
            right: 12px;
            font-size: 16px;
            color: #536471;
            font-weight: bold;
        }
        .state-chip{
          display: inline-flex; align-items: center; justify-content: space-between;
          padding: 0 10px; border:1px solid var(--line); border-radius: 999px; background:#fff;
          font-size: 12px; color: var(--ink-900);
          transition: all .12s; cursor: pointer;
        }
        .state-chip:hover{ background:#f3f6ff; border-color:#d8defe; }
        .state-chip.active{ background:#e8f0ff; border-color:#8ea1ff; color:#0b57d0; }
        .state-chip .code{ font-weight:700; letter-spacing:.4px; }
        .state-chip .count{ opacity:.8; }

        /* SECTION TITLES */
        .section-title{
          font-size: 13px; font-weight: 700; color: var(--ink-600);
          border-bottom: 1px solid var(--line); padding-bottom: 6px; margin-bottom: 10px;
        }

        /* TABLE DENSITY */
        .compact .event-item{ padding: 8px 10px; }
    </style>
</head>
<body>
    <div class="container">
        <a href="home.html" class="back-link">← Back to Home</a>
        
        <h1>
            <span>📚</span>
            Directory
        </h1>

        <!-- Stats Section -->
        <div class="stats-container">
            <div class="stat-card">
                <div class="number" id="total-count">0</div>
                <div class="label">Total Entries</div>
            </div>
            <div class="stat-card">
                <div class="number" id="person-count">0</div>
                <div class="label">People</div>
            </div>
            <div class="stat-card">
                <div class="number" id="org-count">0</div>
                <div class="label">Organizations</div>
            </div>
            <div class="stat-card">
                <div class="number" id="chapter-count">0</div>
                <div class="label">Chapters</div>
            </div>
        </div>

        <!-- Filters Section -->
        <div class="filters-container">
            <!-- Type Filter Buttons -->
            <div class="type-filters">
                <button class="type-btn active" onclick="filterByType('all')">All</button>
                <button class="type-btn" onclick="filterByType('person')">People</button>
                <button class="type-btn" onclick="filterByType('organization')">Organizations</button>
                <button class="type-btn" onclick="filterByType('chapter')">Chapters</button>
            </div>

            <!-- Search Bar -->
            <div class="search-container">
                <input type="text" class="search-input" id="quick-search" 
                       placeholder="Quick search by name, city, state..." 
                       oninput="performQuickSearch()">
                <button class="btn btn-secondary" onclick="toggleAdvancedSearch()">
                    Advanced Search ▼
                </button>
            </div>

            <!-- Advanced Search -->
            <div class="advanced-search" id="advanced-search">
                <h4 style="margin-bottom: 15px;">Advanced Search</h4>
                <div class="form-grid">
                    <div class="form-group">
                        <label>Name</label>
                        <input type="text" id="search-name" placeholder="Enter name...">
                    </div>
                    <div class="form-group">
                        <label>City</label>
                        <input type="text" id="search-city" placeholder="Enter city...">
                    </div>
                    <div class="form-group">
                        <label>State</label>
                        <input type="text" id="search-state" placeholder="Enter state...">
                    </div>
                    <div class="form-group">
                        <label>Region</label>
                        <input type="text" id="search-region" placeholder="Enter region...">
                    </div>
                    <div class="form-group">
                        <label>Description</label>
                        <input type="text" id="search-about" placeholder="Enter description...">
                    </div>
                    <div class="form-group">
                        <label>Type</label>
                        <select id="search-type">
                            <option value="">All Types</option>
                            <option value="person">Person</option>
                            <option value="organization">Organization</option>
                            <option value="chapter">Chapter</option>
                        </select>
                    </div>
                </div>
                <div style="display: flex; gap: 10px;">
                    <button class="btn btn-primary" onclick="performAdvancedSearch()">Search</button>
                    <button class="btn btn-secondary" onclick="clearAdvancedSearch()">Clear</button>
                </div>
            </div>
        </div>

        <!-- View Toggle -->
        <div class="view-toggle">
            <button class="view-btn active" onclick="toggleView('table')" id="table-view-btn">
                <span>⚟</span> Table View
            </button>
            <button class="view-btn" onclick="toggleView('cards')" id="cards-view-btn">
                <span>▦</span> Cards View
            </button>
        </div>

        <!-- Directory Container -->
        <div id="directory-container">
            <!-- Cards View -->
            <div class="directory-cards" id="directory-cards">
                <!-- Cards will be dynamically inserted here -->
            </div>
            
            <!-- Table View -->
            <table class="directory-table" id="directory-table">
                <thead>
                    <tr>
                        <th onclick="sortBy('actor_type')">Type ↕</th>
                        <th onclick="sortBy('name')">Name ↕</th>
                        <th onclick="sortBy('city')">City ↕</th>
                        <th onclick="sortBy('state')">State ↕</th>
                        <th onclick="sortBy('region')">Region ↕</th>
                        <th>Description</th>
                    </tr>
                </thead>
                <tbody id="directory-tbody">
                    <tr>
                        <td colspan="6">
                            <div class="loading-container">
                                <div class="spinner"></div>
                                <div>Loading directory...</div>
                            </div>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>

        <!-- Load More Button -->
        <div class="load-more-container" id="load-more-container" style="display: none;">
            <button class="btn btn-primary" onclick="loadMore()">Load More</button>
        </div>
    </div>

    <!-- Enhanced Actor Detail Modal (from Analytics) -->
        <div id="actor-detail-modal" class="actor-modal" style="display: none;">
      <div class="actor-modal-header">
        <div class="actor-content">
          <div class="header-row">
            <button class="btn-back" onclick="closeActorDetail()">← Back</button>
            <div class="actor-name" id="actor-name"></div>
            <span class="type-chip" id="actor-type-chip"></span>
          </div>
          <div class="kpi-bar" id="actor-kpis"></div>
        </div>
      </div>
      <div class="actor-modal-body">
        <div class="actor-content">
          <div class="content-grid">
            <div class="left-col">
              <div class="section-card">
                <div class="section-title">Social Media</div>
                <div id="actor-handles"></div>
              </div>

              <div class="section-card">
                <div class="section-title">Basic Information</div>
                <dl class="info-grid" id="actor-info-grid"></dl>
              </div>

              <div class="section-card" id="actor-coverage-section">
                <div class="section-title">Coverage by State</div>
                <div class="coverage-grid" id="coverage-grid"></div>
              </div>

              <div class="section-card" id="actor-relationships-section" style="display:none;">
                <div class="section-title">Actor Relationships</div>
                <div id="actor-relationships"></div>
              </div>
            </div>

            <div class="right-col">
              <div class="section-card" id="actor-members-section" style="display:none;">
                <div class="section-title">Members &amp; Employees <span id="actor-members-count"></span></div>
                <div id="actor-members-list" class="actor-members-list"></div>
              </div>

              <div class="section-card">
                <div class="section-title">Linked Events <span id="actor-events-count"></span></div>
                <div class="actor-events-controls">
                    <input type="text"
                           id="actor-events-search"
                           class="actor-search-input"
                           placeholder="Search events..."
                           onkeyup="searchActorEvents(event)">

                    <div class="actor-page-size-controls">
                        <label>Events per page:</label>
                        <select id="actor-page-size" onchange="changeActorPageSize()">
                            <option value="10">10</option>
                            <option value="50" selected>50</option>
                            <option value="100">100</option>
                            <option value="1000">1000</option>
                        </select>
                    </div>

                    <div class="actor-export-dropdown">
                        <button class="actor-export-button" id="actor-export-csv-btn" onclick="toggleActorExportMenu(event)">📥 Export CSV ▼</button>
                        <div class="actor-export-menu" id="actor-export-menu" style="display: none;">
                            <button onclick="exportActorEventsCSV({ scope:'visible' })">📊 Actor Events (visible)</button>
                            <button onclick="exportActorEventsCSV({ scope:'all' })">📊 Actor Events (all time)</button>
                            <button onclick="exportActorSummaryCSV()">🧾 Actor Summary</button>
                            <button onclick="exportActorMembersCSV()" id="export-members-btn" style="display:none;">👥 Members (visible)</button>
                        </div>
                    </div>

                    <div class="actor-density-toggle">
                        <label style="display:flex; align-items:center; gap:4px; font-size:13px;">
                            <input type="checkbox" id="events-compact-toggle" onchange="toggleEventsCompact()">
                            Compact
                        </label>
                    </div>
                </div>
                <div id="actor-events" class="actor-events-list"></div>
                <div id="actor-pagination" class="actor-pagination"></div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
    <script>
        // Configuration
        const SUPABASE_URL = 'https://djzrlccihwqxtjkytcph.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRqenJsY2NpaHdxeHRqa3l0Y3BoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTE5MzcwMDEsImV4cCI6MjA2NzUxMzAwMX0.ZfXHyQExHbIRLBHbw77KaHd2dKupsBhPAKz-zBFkSUQ';

        // State
        let allActors = [];
        let filteredActors = [];
        let currentOffset = 0;
        const pageSize = 1000;  // Supabase max limit per request
        let currentTypeFilter = 'all';
        let currentSortField = 'name';
        let currentSortDirection = 'asc';
        let isLoading = false;
        let hasMore = true;
        let isAdvancedSearch = false;
        let advancedSearchQuery = null;

        // Function to show all participants
        function showAllParticipants(eventId) {
            const allParticipantsDiv = document.getElementById(`${eventId}-all-participants`);
            const moreBtn = document.getElementById(`${eventId}-more-btn`);
            
            if (allParticipantsDiv && moreBtn) {
                allParticipantsDiv.style.display = 'block';
                moreBtn.style.display = 'none';
            }
        }
        
        // Twitter widget loader removed - using styled cards instead of embeds
        
        // Function to load event posts
        async function loadEventPosts(eventId, elementId) {
            console.log('loadEventPosts called with:', eventId, elementId);
            const container = document.getElementById(`${elementId}-posts-container`);
            console.log('Container found:', container);
            
            if (!container) {
                console.error('Posts container not found for:', `${elementId}-posts-container`);
                return;
            }
            
            container.innerHTML = '<div style="color: #666; font-size: 12px;">Loading posts...</div>';
            
            try {
                // Fetch posts linked to this event - using v2_social_media_posts table
                const postLinks = await supabaseRequest(
                    `v2_event_post_links?select=*,post:v2_social_media_posts!v2_event_post_links_post_id_fkey(*)&event_id=eq.${eventId}&limit=10`
                );
                
                console.log('Post links for event', eventId, ':', postLinks);
                
                if (postLinks && postLinks.length > 0) {
                    const postsHtml = postLinks.map(link => {
                        const post = link.post;
                        if (!post) return '';
                        
                        // Create embedded post based on platform
                        if (post.post_url && (post.post_url.includes('twitter.com') || post.post_url.includes('x.com'))) {
                            // Twitter/X - use styled card display (embeds not working reliably)
                            const tweetId = post.post_url.match(/status\/(\d+)/)?.[1];
                            const authorHandle = post.author_handle || 'user';
                            const authorName = post.author_name || authorHandle;
                            
                            return `
                                <div class="twitter-card" style="padding: 12px; margin-bottom: 8px; background: #f7f9fa; border: 1px solid #cfd9de; border-radius: 12px; position: relative;">
                                    <div style="position: absolute; top: 12px; right: 12px; font-size: 16px; color: #536471; font-weight: bold;">𝕏</div>
                                    <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 8px;">
                                        <div style="font-size: 12px; color: #536471;">
                                            <strong style="color: #0f1419;">${authorName}</strong>
                                            <span style="color: #536471;">@${authorHandle}</span> • 
                                            ${post.post_timestamp ? new Date(post.post_timestamp).toLocaleDateString('en-US', { month: 'short', day: 'numeric' }) : ''}
                                        </div>
                                    </div>
                                    <div style="font-size: 14px; color: #0f1419; line-height: 1.5; margin-bottom: 12px;">
                                        ${(post.content_text || 'No content available').substring(0, 280)}
                                        ${(post.content_text || '').length > 280 ? '...' : ''}
                                    </div>
                                    ${post.like_count || post.share_count ? `
                                        <div style="display: flex; gap: 20px; margin-bottom: 8px;">
                                            ${post.like_count ? `<span style="font-size: 12px; color: #536471;">❤️ ${post.like_count.toLocaleString()}</span>` : ''}
                                            ${post.share_count ? `<span style="font-size: 12px; color: #536471;">🔁 ${post.share_count.toLocaleString()}</span>` : ''}
                                        </div>
                                    ` : ''}
                                    <a href="${post.post_url}" target="_blank" onclick="event.stopPropagation()" 
                                       style="font-size: 12px; color: #1d9bf0; text-decoration: none; font-weight: 500;">
                                        View on Twitter/X →
                                    </a>
                                </div>
                            `;
                        }
                        
                        // Fallback for non-embeddable posts
                        return `
                            <div style="padding: 12px; margin-bottom: 8px; background: white; border: 1px solid #e9ecef; border-radius: 6px;">
                                <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 8px;">
                                    <div style="font-size: 11px; color: #6c757d;">
                                        <strong>@${post.author_handle || 'Unknown'}</strong> • 
                                        <strong>${post.platform || 'Social Media'}</strong> • 
                                        ${post.post_timestamp ? new Date(post.post_timestamp).toLocaleDateString() : 'No date'}
                                    </div>
                                    ${post.like_count || post.share_count ? `
                                        <div style="font-size: 10px; color: #888;">
                                            👍 ${post.like_count || 0} • 
                                            🔄 ${post.share_count || 0}
                                        </div>
                                    ` : ''}
                                </div>
                                <div style="font-size: 13px; color: #333; line-height: 1.5; margin-bottom: 8px;">
                                    ${(post.content_text || 'No content available').substring(0, 280)}
                                    ${(post.content_text || '').length > 280 ? '...' : ''}
                                </div>
                                ${post.post_url ? `
                                    <a href="${post.post_url}" target="_blank" onclick="event.stopPropagation()" 
                                       style="font-size: 12px; color: #4facfe; text-decoration: none;">
                                        View Original Post →
                                    </a>
                                ` : ''}
                            </div>
                        `;
                    }).filter(html => html).join('');
                    
                    if (postsHtml) {
                        container.innerHTML = `
                            <div style="max-height: 400px; overflow-y: auto; padding-right: 5px;">
                                ${postsHtml}
                            </div>
                        `;
                        
                        // Twitter embeds removed - using styled cards instead
                    } else {
                        container.innerHTML = '<div style="color: #666; font-size: 12px;">No displayable posts found.</div>';
                    }
                } else {
                    container.innerHTML = '<div style="color: #666; font-size: 12px;">No posts found for this event.</div>';
                }
            } catch (error) {
                console.error('Error loading posts:', error);
                container.innerHTML = '<div style="color: #dc3545; font-size: 12px;">Error loading posts</div>';
            }
        }
        
        // Make functions globally accessible
        window.toggleEventDetails = toggleEventDetails;
        window.filterOrganizationMembers = filterOrganizationMembers;
        window.showDetails = showDetails;
        window.showAllParticipants = showAllParticipants;
        window.loadEventPosts = loadEventPosts;
        
        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            loadDirectory();
            
            // Apply saved view preference
            const savedView = localStorage.getItem('directoryView');
            if (savedView === 'cards') {
                // Will be applied after actors are loaded
                // The displayActors function handles this
            }
        });

        // API Request Helper
        async function supabaseRequest(endpoint, options = {}) {
            const url = `${SUPABASE_URL}/rest/v1/${endpoint}`;
            const headers = {
                'apikey': SUPABASE_KEY,
                'Authorization': `Bearer ${SUPABASE_KEY}`,
                'Content-Type': 'application/json',
                'Prefer': 'return=representation',
                ...(options.headers || {})
            };
            
            console.log('API Request:', endpoint);

            const response = await fetch(url, {
                ...options,
                headers
            });

            if (!response.ok) {
                const errorText = await response.text();
                console.error('API Error:', response.status, errorText);
                throw new Error(`API Error: ${response.status} - ${errorText}`);
            }

            const data = await response.json();
            console.log('API Response - Count:', data.length);
            return data;
        }

        // Load Directory - fetches ALL actors in batches of 1000
        async function loadDirectory() {
            if (isLoading) return;
            isLoading = true;
            
            console.log('Loading entire directory...');
            
            try {
                allActors = [];
                let offset = 0;
                let batchNumber = 1;
                let keepFetching = true;
                
                // Show initial loading message
                document.getElementById('directory-tbody').innerHTML = `
                    <tr>
                        <td colspan="6">
                            <div class="loading-container">
                                <div class="spinner"></div>
                                <div id="loading-message">Loading directory batch ${batchNumber}...</div>
                            </div>
                        </td>
                    </tr>
                `;
                
                // Keep fetching until we get less than 1000 records
                while (keepFetching) {
                    let query;
                    if (isAdvancedSearch && advancedSearchQuery) {
                        // Use advanced search query with pagination
                        query = advancedSearchQuery + `&order=${currentSortField}.${currentSortDirection}&limit=${pageSize}&offset=${offset}`;
                    } else {
                        // Regular query
                        query = `v2_actors?select=*&order=${currentSortField}.${currentSortDirection}&limit=${pageSize}&offset=${offset}`;
                    }
                    
                    console.log(`Fetching batch ${batchNumber}, offset: ${offset}`);
                    const actors = await supabaseRequest(query);
                    console.log(`Batch ${batchNumber}: received ${actors.length} actors`);
                    
                    allActors = [...allActors, ...actors];
                    
                    // Update loading message
                    const loadingMsg = document.getElementById('loading-message');
                    if (loadingMsg) {
                        loadingMsg.textContent = `Loaded ${allActors.length} actors...`;
                    }
                    
                    // If we got less than 1000, we've reached the end
                    if (actors.length < pageSize) {
                        keepFetching = false;
                    } else {
                        offset += pageSize;
                        batchNumber++;
                    }
                }
                
                console.log(`Total actors loaded: ${allActors.length}`);
                
                filterAndDisplay();
                updateStats();
                
                // Hide load more button since we loaded everything
                document.getElementById('load-more-container').style.display = 'none';
                
            } catch (error) {
                console.error('Error loading directory:', error);
                document.getElementById('directory-tbody').innerHTML = `
                    <tr>
                        <td colspan="6" class="no-results">
                            Error loading directory: ${error.message}
                        </td>
                    </tr>
                `;
            } finally {
                isLoading = false;
            }
        }

        // Filter and Display
        function filterAndDisplay() {
            // Apply type filter
            filteredActors = currentTypeFilter === 'all' 
                ? [...allActors]
                : allActors.filter(a => a.actor_type === currentTypeFilter);

            // Apply search filter
            const searchTerm = document.getElementById('quick-search').value.toLowerCase();
            if (searchTerm) {
                filteredActors = filteredActors.filter(actor => {
                    return (actor.name && actor.name.toLowerCase().includes(searchTerm)) ||
                           (actor.city && actor.city.toLowerCase().includes(searchTerm)) ||
                           (actor.state && actor.state.toLowerCase().includes(searchTerm)) ||
                           (actor.about && actor.about.toLowerCase().includes(searchTerm));
                });
            }

            displayActors(filteredActors);
        }

        // View Toggle Function
        function toggleView(view) {
            const tableView = document.getElementById('directory-table');
            const cardsView = document.getElementById('directory-cards');
            const tableBtn = document.getElementById('table-view-btn');
            const cardsBtn = document.getElementById('cards-view-btn');
            
            if (view === 'cards') {
                tableView.classList.add('hidden');
                cardsView.classList.add('active');
                tableBtn.classList.remove('active');
                cardsBtn.classList.add('active');
                localStorage.setItem('directoryView', 'cards');
            } else {
                tableView.classList.remove('hidden');
                cardsView.classList.remove('active');
                tableBtn.classList.add('active');
                cardsBtn.classList.remove('active');
                localStorage.setItem('directoryView', 'table');
            }
            
            // Re-render in the selected view
            displayActors(filteredActors.length > 0 ? filteredActors : allActors);
        }
        
        // Render Actor Card
        function renderActorCard(actor) {
            const initial = actor.name ? actor.name.charAt(0).toUpperCase() : '?';
            const location = [actor.city, actor.state].filter(Boolean).join(', ') || 'Location not specified';
            const eventCount = actor.event_count || 0;
            const stateCount = actor.state_count || 0;
            
            return `
                <div class="actor-card" onclick="showDetails('${actor.id}')">
                    <div class="card-header">
                        <div class="actor-avatar">
                            ${initial}
                        </div>
                        <span class="actor-type-badge ${actor.actor_type || 'unknown'}">
                            ${actor.actor_type || 'unknown'}
                        </span>
                    </div>
                    <div class="card-body">
                        <h3>${actor.name || 'Unnamed Actor'}</h3>
                        <div class="card-location">
                            📍 ${location}
                        </div>
                    </div>
                    <div class="card-stats">
                        <div class="stat-item">
                            <span class="stat-value">${eventCount}</span>
                            <span class="stat-label">Events</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-value">${stateCount}</span>
                            <span class="stat-label">States</span>
                        </div>
                    </div>
                    <div class="card-actions">
                        <button class="card-btn primary" onclick="event.stopPropagation(); showDetails('${actor.id}')">
                            View Details
                        </button>
                    </div>
                </div>
            `;
        }

        // Display Actors (both table and cards)
        function displayActors(actors) {
            const tbody = document.getElementById('directory-tbody');
            const cardsContainer = document.getElementById('directory-cards');
            
            // Check current view preference
            const currentView = localStorage.getItem('directoryView') || 'table';

            if (actors.length === 0) {
                const noResultsMessage = `
                    <div class="no-results" style="text-align: center; padding: 40px; color: #666;">
                        <h3>No entries found</h3>
                        <p>Try adjusting your filters.</p>
                    </div>
                `;
                
                tbody.innerHTML = `
                    <tr>
                        <td colspan="6" class="no-results">
                            No entries found. Try adjusting your filters.
                        </td>
                    </tr>
                `;
                cardsContainer.innerHTML = noResultsMessage;
                return;
            }

            // Render table view
            tbody.innerHTML = actors.map(actor => `
                <tr onclick="showDetails('${actor.id}')">
                    <td><span class="type-badge ${actor.actor_type}">${actor.actor_type}</span></td>
                    <td><strong>${actor.name || 'N/A'}</strong></td>
                    <td>${actor.city || 'N/A'}</td>
                    <td>${actor.state || 'N/A'}</td>
                    <td>${actor.region || 'N/A'}</td>
                    <td>${actor.about ? actor.about.substring(0, 100) + '...' : 'No description'}</td>
                </tr>
            `).join('');
            
            // Render cards view
            cardsContainer.innerHTML = actors.map(actor => renderActorCard(actor)).join('');
            
            // Apply saved view preference on load
            if (currentView === 'cards' && !document.getElementById('directory-cards').classList.contains('active')) {
                toggleView('cards');
            }
        }

        // Update Stats
        function updateStats() {
            document.getElementById('total-count').textContent = allActors.length;
            document.getElementById('person-count').textContent = allActors.filter(a => a.actor_type === 'person').length;
            document.getElementById('org-count').textContent = allActors.filter(a => a.actor_type === 'organization').length;
            document.getElementById('chapter-count').textContent = allActors.filter(a => a.actor_type === 'chapter').length;
        }

        // Filter by Type
        function filterByType(type) {
            console.log('Filtering by type:', type);
            currentTypeFilter = type;
            
            // Update button states
            document.querySelectorAll('.type-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            
            filterAndDisplay();
        }

        // Quick Search
        function performQuickSearch() {
            filterAndDisplay();
        }

        // Toggle Advanced Search
        function toggleAdvancedSearch() {
            const advSearch = document.getElementById('advanced-search');
            advSearch.classList.toggle('show');
        }

        // Perform Advanced Search
        async function performAdvancedSearch() {
            const name = document.getElementById('search-name').value.trim();
            const city = document.getElementById('search-city').value.trim();
            const state = document.getElementById('search-state').value.trim();
            const region = document.getElementById('search-region').value.trim();
            const about = document.getElementById('search-about').value.trim();
            const type = document.getElementById('search-type').value;
            
            console.log('Advanced search with:', {name, city, state, region, about, type});

            if (!name && !city && !state && !region && !about && !type) {
                alert('Please enter at least one search criterion');
                return;
            }

            try {
                // Build query conditions
                let conditions = [];
                if (name) conditions.push(`name.ilike.*${encodeURIComponent(name)}*`);
                if (city) conditions.push(`city.ilike.*${encodeURIComponent(city)}*`);
                if (state) conditions.push(`state.ilike.*${encodeURIComponent(state)}*`);
                if (region) conditions.push(`region.ilike.*${encodeURIComponent(region)}*`);
                if (about) conditions.push(`about.ilike.*${encodeURIComponent(about)}*`);
                if (type) conditions.push(`actor_type.eq.${type}`);

                // Store the query for pagination
                advancedSearchQuery = `v2_actors?select=*&${conditions.join('&')}`;
                isAdvancedSearch = true;
                currentOffset = 0;
                allActors = [];
                
                console.log('Advanced search query:', advancedSearchQuery);
                
                // Load first page of results
                await loadDirectory(false);

            } catch (error) {
                console.error('Error performing search:', error);
                alert('Error performing search: ' + error.message);
            }
        }

        // Clear Advanced Search
        function clearAdvancedSearch() {
            document.getElementById('search-name').value = '';
            document.getElementById('search-city').value = '';
            document.getElementById('search-state').value = '';
            document.getElementById('search-region').value = '';
            document.getElementById('search-about').value = '';
            document.getElementById('search-type').value = '';
            
            // Reset to normal mode
            isAdvancedSearch = false;
            advancedSearchQuery = null;
            currentOffset = 0;
            
            loadDirectory();
        }

        // Sort By
        function sortBy(field) {
            if (currentSortField === field) {
                currentSortDirection = currentSortDirection === 'asc' ? 'desc' : 'asc';
            } else {
                currentSortField = field;
                currentSortDirection = 'asc';
            }
            currentOffset = 0;  // Reset offset when sorting
            loadDirectory();
        }

        // Load More - no longer needed since we load everything
        function loadMore() {
            // Deprecated - we now load all actors at once
        }

        // Global variables for actor modal
        let currentActorData = null;
        let currentActorEvents = [];
        let currentActorMembers = [];
        let filteredActorMembers = [];
        let actorModalPage = 1;
        let actorModalPageSize = 50;
        let actorEventSearchTerm = '';
        let currentFilteredActorEvents = [];
        let activeStateFilter = null; // single-select to keep UX simple
        
        // Navigation history for back button
        let actorNavigationHistory = [];

        // Enhanced Show Details Modal (from Analytics)
        async function showDetails(actorId, isPushToHistory = true) {
            console.log('Opening enhanced actor detail for ID:', actorId);
            const modal = document.getElementById('actor-detail-modal');
            if (!modal) {
                console.error('Actor detail modal not found');
                return;
            }
            
            // If modal is not visible, this is a fresh navigation from the directory
            if (modal.style.display === 'none' || !modal.style.display) {
                actorNavigationHistory = [];
                console.log('Starting fresh navigation');
            }
            
            // Add current actor to history if we're navigating to a new actor (not going back)
            if (isPushToHistory && currentActorData && currentActorData.id !== actorId) {
                actorNavigationHistory.push(currentActorData.id);
                console.log('Added to history:', currentActorData.id, 'History length:', actorNavigationHistory.length);
            }
            
            // Update back button text based on history
            updateBackButton();
            
            // Show modal immediately with loading state
            modal.style.display = 'block';
            
            // Reset modal content to loading state
            document.getElementById('actor-name').textContent = 'Loading...';
            document.getElementById('actor-type-chip').textContent = '';
            document.getElementById('actor-type-chip').className = 'type-chip';
            activeStateFilter = null;
            currentFilteredActorEvents = [];
            document.getElementById('actor-coverage-section').style.display = 'none';
            document.getElementById('coverage-grid').innerHTML = '';
            
            // Clear content areas
            document.getElementById('actor-info-grid').innerHTML = '<dt>Loading...</dt>';
            document.getElementById('actor-handles').innerHTML = '<div class="loading">Loading social media...</div>';
            const eventsEl = document.getElementById('actor-events');
            if (eventsEl) {
                eventsEl.innerHTML = '<div class="loading">Loading events...</div>';
                eventsEl.classList.add('compact');
            }

            try {
                // Fetch full actor details
                console.log('Fetching actor details...');
                const actorResponse = await supabaseRequest(`v2_actors?select=*&id=eq.${actorId}`);
                const actorData = actorResponse[0];
                currentActorData = actorData;
                
                if (!actorData) {
                    throw new Error('Actor not found');
                }
                
                console.log('Actor data:', actorData);
                
                // Fetch related data in parallel
                const [events, usernames, relationships] = await Promise.all([
                    // Fetch ALL events with full details including other actors
                    // Fetch events with all actor links to show other participants
                    supabaseRequest(
                        `v2_event_actor_links?select=actor_type,platform,created_at,v2_events:v2_event_actor_links_event_id_fkey(*,v2_event_actor_links(*,actor:v2_actors!v2_event_actor_links_actor_id_fkey(id,name,actor_type))),actor:v2_actors!v2_event_actor_links_actor_id_fkey(id,name,actor_type)&actor_id=eq.${actorId}&limit=1000`
                    ).catch(err => {
                        console.error('Error fetching events:', err);
                        return [];
                    }),
                    // Fetch usernames
                    supabaseRequest(
                        `v2_actor_usernames?select=*&actor_id=eq.${actorId}`
                    ).catch(err => {
                        console.error('Error fetching usernames:', err);
                        return [];
                    }),
                    // Fetch relationships - fixed query
                    supabaseRequest(
                        `v2_actor_links?select=*&from_actor_id=eq.${actorId}`
                    ).then(async links => {
                        // Fetch the related actor names separately
                        for (let link of links) {
                            try {
                                const [relatedActor] = await supabaseRequest(
                                    `v2_actors?select=name,actor_type&id=eq.${link.to_actor_id}`
                                );
                                link.to_actor = relatedActor;
                            } catch (err) {
                                console.error('Error fetching related actor:', err);
                                link.to_actor = { name: 'Unknown', actor_type: 'unknown' };
                            }
                        }
                        return links;
                    }).catch(err => {
                        console.error('Error fetching relationships:', err);
                        return [];
                    })
                ]);
                
                console.log('Events:', events.length, 'Usernames:', usernames.length, 'Relationships:', relationships.length);
                
                // Log sample event structure to understand the data
                if (events.length > 0) {
                    console.log('Sample event structure:', events[0]);
                }

                // Populate the modal with the fetched data
                await populateActorModal(actorData, events, usernames, relationships);

            } catch (error) {
                console.error('Error loading details:', error);
                document.getElementById('actor-info-grid').innerHTML = `
                    <div class="no-results">Error loading details: ${error.message}</div>
                `;
            }
        }

        // Populate the enhanced actor modal with all data
        async function populateActorModal(actor, events, usernames, relationships) {
            // Update header information
            const name = actor.name || 'Unknown';
            const actorType = actor.actor_type || 'unknown';
            
            document.getElementById('actor-name').textContent = name;

            const typeBadge = document.getElementById('actor-type-chip');
            typeBadge.textContent = actorType;
            typeBadge.className = 'type-chip';

            // Populate sections
            renderInfoGrid(actor);
            populateSocialMediaSection(usernames);
            
            if (relationships && relationships.length > 0) {
                populateRelationshipsSection(relationships);
            }
            
            // For organizations, fetch and display members
            if (actor.actor_type === 'organization') {
                document.getElementById('actor-members-section').style.display = 'block';
                await fetchOrganizationMembers(actor.id);
            } else {
                document.getElementById('actor-members-section').style.display = 'none';
            }

            // Populate events
            currentActorEvents = events;
            buildActorKPIs(events, actor);
            buildCoverageGrid(events);
            document.getElementById('export-members-btn').style.display =
              actor.actor_type === 'organization' ? 'block' : 'none';
            displayActorEvents();
        }

        function buildActorKPIs(events, actor) {
            const byDate = events
                .map(e => e.v2_events?.event_date ? new Date(e.v2_events.event_date) : null)
                .filter(Boolean)
                .sort((a,b) => a - b);

            const today = new Date();
            const ninetyAgo = new Date(); ninetyAgo.setDate(today.getDate() - 90);

            const total = events.length;
            const last90 = events.filter(e => {
                const d = e.v2_events?.event_date ? new Date(e.v2_events.event_date) : null;
                return d && d >= ninetyAgo && d <= today;
            }).length;

            const cities = new Set(events.map(e => e.v2_events?.city).filter(Boolean)).size;
            const states = new Set(events.map(e => e.v2_events?.state).filter(Boolean)).size;

            const first = byDate[0];
            const last = byDate[byDate.length - 1];
            const dateRange = (first && last)
                ? `${first.toLocaleDateString()} - ${last.toLocaleDateString()}`
                : '—';

            const lastActivity = last ? last.toLocaleDateString() : '—';
            const yearsActive = (first && last)
                ? Math.max(1, today.getFullYear() - first.getFullYear() + (today >= first ? 0 : -1))
                : '—';

            const kpis = [
                `<span class="kpi"><strong>${total}</strong><span class="muted">events</span><span class="muted">/</span><strong>${last90}</strong><span class="muted">90d</span></span>`,
                `<span class="kpi"><strong>${cities}</strong><span class="muted">cities</span></span>`,
                `<span class="kpi"><strong>${states}</strong><span class="muted">states</span></span>`,
                `<span class="kpi"><strong>${dateRange}</strong><span class="muted">date range</span></span>`,
                `<span class="kpi"><strong>${lastActivity}</strong><span class="muted">last activity</span></span>`,
                `<span class="kpi"><strong>${yearsActive}</strong><span class="muted">yrs active</span></span>`
            ];

            document.getElementById('actor-kpis').innerHTML = kpis.join('');
        }

        function populateSocialMediaSection(usernames) {
            const container = document.getElementById('actor-handles');
            if (!usernames || usernames.length === 0) {
                container.innerHTML = '<div style="color: #666; font-size: 14px;">No social media accounts linked</div>';
                return;
            }
            const platformIcons = {
                'twitter': '𝕏',
                'x': '𝕏',
                'instagram': '📷',
                'facebook': 'f',
                'tiktok': '♪',
                'youtube': '▶',
                'truth_social': 'T'
            };
            const links = usernames.map(u => {
                const icon = platformIcons[u.platform.toLowerCase()] || '🔗';
                const followerText = u.follower_count ? ` (${u.follower_count.toLocaleString()} followers)` : '';
                const verifiedIcon = u.verified ? ' ✓' : '';
                return `
                    <a href="#" class="social-link" onclick="event.preventDefault()">
                        <span>${icon}</span>
                        <span>@${u.username}${verifiedIcon}${followerText}</span>
                    </a>
                `;
            }).join('');
            container.innerHTML = links;
        }

        function renderInfoGrid(actor){
            const grid = document.getElementById('actor-info-grid');
            const rows = [
                ['Name', actor.name || '—'],
                ['Type', actor.actor_type || '—'],
                ['City', actor.city || '—'],
                ['State', actor.state || '—'],
                ['Region', actor.region || '—'],
                ['Description', `<div class="desc" id="actor-desc">${actor.about || '—'}</div>`],
                ['Created', actor.created_at ? new Date(actor.created_at).toLocaleString() : '—'],
                ['Updated', actor.updated_at ? new Date(actor.updated_at).toLocaleString() : '—'],
            ];

            grid.innerHTML = rows.map(([label, val]) =>
                `<dt>${label}</dt><dd>${val}</dd>`
            ).join('');

            const desc = document.getElementById('actor-desc');
            if (desc && desc.textContent && desc.textContent.length > 280) {
                const btn = document.createElement('button');
                btn.textContent = 'Read more';
                btn.style.cssText = 'margin-top:6px;font-size:12px;color:#0b57d0;';
                btn.onclick = () => {
                    desc.classList.toggle('expanded');
                    btn.textContent = desc.classList.contains('expanded') ? 'Show less' : 'Read more';
                };
                desc.parentElement.appendChild(btn);
            }
        }

        function populateRelationshipsSection(relationships) {
            const section = document.getElementById('actor-relationships-section');
            const container = document.getElementById('actor-relationships');
            if (!relationships || relationships.length === 0) {
                section.style.display = 'none';
                return;
            }
            section.style.display = 'block';
            const items = relationships.map(rel => {
                const toActor = rel.to_actor || rel.v2_actors || {};
                const toActorName = toActor.name || 'Unknown';
                const toActorType = toActor.actor_type || 'unknown';
                return `
                    <div class="relationship-item" onclick="showDetails('${rel.to_actor_id}')">
                        <div>
                            <div class="relationship-type">${rel.relationship || 'Related'}</div>
                            <div class="relationship-name">${toActorName}</div>
                        </div>
                        <span class="relationship-badge">${toActorType}</span>
                    </div>
                `;
            }).join('');
            container.innerHTML = items;
        }

        function displayActorEvents() {
            let filteredEvents = currentFilteredActorEvents.length ? currentFilteredActorEvents : currentActorEvents;

            // Update count
            document.getElementById('actor-events-count').textContent = `(${filteredEvents.length})`;
            
            // Calculate pagination
            const totalPages = Math.ceil(filteredEvents.length / actorModalPageSize);
            const startIndex = (actorModalPage - 1) * actorModalPageSize;
            const endIndex = startIndex + actorModalPageSize;
            const pageEvents = filteredEvents.slice(startIndex, endIndex);
            
            // Display events
            const container = document.getElementById('actor-events');
            
            if (pageEvents.length === 0) {
                container.innerHTML = '<div style="text-align: center; color: #666; padding: 20px;">No events found</div>';
            } else {
                container.innerHTML = pageEvents.map((e, index) => {
                    const event = e.v2_events;
                    if (!event) return '';
                    
                    const date = event.event_date ? new Date(event.event_date).toLocaleDateString() : 'No date';
                    const location = [event.city, event.state].filter(Boolean).join(', ') || 'Unknown location';
                    const eventId = `actor-event-${startIndex + index}`;
                    
                    // Get other participants for this event
                    // Check if we have nested actor links
                    let otherParticipants = [];
                    try {
                        if (event.v2_event_actor_links && Array.isArray(event.v2_event_actor_links)) {
                            otherParticipants = event.v2_event_actor_links
                                .filter(link => link && link.actor && link.actor.id !== currentActorData.id)
                                .map(link => link.actor)
                                .filter(actor => actor && actor.id && actor.name);
                            
                            console.log(`Event ${event.event_name} has ${otherParticipants.length} other participants:`, otherParticipants);
                        }
                    } catch (err) {
                        console.warn('Error processing participants:', err);
                    }
                    
                    // Get post IDs from the event if available
                    // We'll need to fetch these separately if we have the linking structure
                    const posts = [];
                    
                    // Store event data for potential post fetching
                    if (!window.eventPostsCache) window.eventPostsCache = {};
                    const cacheKey = `${currentActorData.id}-${event.id}`;
                    window.eventPostsCache[cacheKey] = { event, eventId };
                    
                    return `
                        <div class="event-item clickable-event" id="${eventId}" data-event-id="${event.id}" style="cursor: pointer; transition: all 0.3s;" onclick="window.toggleEventDetails('${eventId}')">
                            <div class="event-header">
                                <div class="event-date">${date}</div>
                                <div class="event-name">${event.event_name || 'Unnamed Event'}</div>
                                <div class="event-location">📍 ${location}</div>
                            </div>
                            <div class="event-details" id="${eventId}-details" style="display: none; margin-top: 15px; padding: 15px; background: #f8f9fa; border-radius: 6px;">
                                <!-- Basic Event Information -->
                                ${event.description ? `
                                    <div style="margin-bottom: 12px;">
                                        <strong style="color: #495057; font-size: 12px; text-transform: uppercase;">Description</strong>
                                        <div style="font-size: 13px; color: #555; margin-top: 4px;">${event.description}</div>
                                    </div>` : ''}
                                
                                ${event.venue ? `
                                    <div style="margin-bottom: 12px;">
                                        <strong style="color: #495057; font-size: 12px; text-transform: uppercase;">Venue</strong>
                                        <div style="font-size: 13px; color: #555; margin-top: 4px;">${event.venue}</div>
                                    </div>` : ''}
                                
                                <!-- Actor's Role & Confidence -->
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 12px;">
                                    ${e.actor_type ? `
                                        <div>
                                            <strong style="color: #495057; font-size: 12px; text-transform: uppercase;">Actor Type</strong>
                                            <div style="font-size: 13px; color: #555; margin-top: 4px;">${e.actor_type}</div>
                                        </div>` : ''}
                                    ${e.platform ? `
                                        <div>
                                            <strong style="color: #495057; font-size: 12px; text-transform: uppercase;">Platform</strong>
                                            <div style="font-size: 13px; color: #555; margin-top: 4px;">${e.platform}</div>
                                        </div>` : ''}
                                </div>
                                
                                ${event.confidence_score ? `
                                    <div style="margin-bottom: 12px;">
                                        <strong style="color: #495057; font-size: 12px; text-transform: uppercase;">Event Confidence</strong>
                                        <div style="font-size: 13px; color: #555; margin-top: 4px;">${(event.confidence_score * 100).toFixed(0)}%</div>
                                    </div>` : ''}
                                
                                <!-- Other Participants -->
                                ${otherParticipants.length > 0 ? `
                                    <div style="margin-bottom: 12px;">
                                        <strong style="color: #495057; font-size: 12px; text-transform: uppercase;">Other Participants (${otherParticipants.length})</strong>
                                        <div id="${eventId}-participants" style="margin-top: 8px;">
                                            <div style="display: flex; flex-wrap: wrap; gap: 6px;">
                                                ${otherParticipants.slice(0, 10).map(p => `
                                                    <span onclick="event.stopPropagation(); showDetails('${p.id}')" 
                                                          style="display: inline-block; padding: 4px 10px; background: white; border: 1px solid #dee2e6; border-radius: 15px; font-size: 12px; color: #495057; cursor: pointer; transition: all 0.2s;"
                                                          onmouseover="this.style.background='#e3f2fd'; this.style.borderColor='#4facfe';"
                                                          onmouseout="this.style.background='white'; this.style.borderColor='#dee2e6';">
                                                        ${p.name || 'Unknown'}
                                                    </span>
                                                `).join('')}
                                                ${otherParticipants.length > 10 ? `
                                                    <span id="${eventId}-more-btn" 
                                                          onclick="event.stopPropagation(); showAllParticipants('${eventId}')" 
                                                          style="display: inline-block; padding: 4px 10px; background: #e3f2fd; border: 1px solid #4facfe; border-radius: 15px; font-size: 12px; color: #0066cc; cursor: pointer; transition: all 0.2s;"
                                                          onmouseover="this.style.background='#4facfe'; this.style.color='white';"
                                                          onmouseout="this.style.background='#e3f2fd'; this.style.color='#0066cc';">
                                                        +${otherParticipants.length - 10} more (click to see all)
                                                    </span>
                                                ` : ''}
                                            </div>
                                            <!-- Hidden section for all participants -->
                                            ${otherParticipants.length > 10 ? `
                                                <div id="${eventId}-all-participants" style="display: none; margin-top: 8px;">
                                                    <div style="display: flex; flex-wrap: wrap; gap: 6px;">
                                                        ${otherParticipants.slice(10).map(p => `
                                                            <span onclick="event.stopPropagation(); showDetails('${p.id}')" 
                                                                  style="display: inline-block; padding: 4px 10px; background: white; border: 1px solid #dee2e6; border-radius: 15px; font-size: 12px; color: #495057; cursor: pointer; transition: all 0.2s;"
                                                                  onmouseover="this.style.background='#e3f2fd'; this.style.borderColor='#4facfe';"
                                                                  onmouseout="this.style.background='white'; this.style.borderColor='#dee2e6';">
                                                                ${p.name || 'Unknown'}
                                                            </span>
                                                        `).join('')}
                                                    </div>
                                                </div>
                                            ` : ''}
                                        </div>
                                    </div>` : ''}
                                
                                <!-- Social Media Posts Section -->
                                <div id="${eventId}-posts-section" style="margin-bottom: 12px;">
                                    ${event.source_post_ids?.length ? `
                                        <div>
                                            <strong style="color: #495057; font-size: 12px; text-transform: uppercase;">Source Posts</strong>
                                            <div id="${eventId}-posts-container" style="margin-top: 8px;"></div>
                                        </div>
                                    ` : ''}
                                </div>
                                
                                <!-- Justification/AI Analysis -->
                                ${event.justification ? `
                                    <div style="margin-bottom: 12px;">
                                        <strong style="color: #495057; font-size: 12px; text-transform: uppercase;">AI Analysis</strong>
                                        <div style="font-size: 13px; color: #555; margin-top: 4px; background: #fff3cd; padding: 8px; border-radius: 4px; border-left: 3px solid #ffc107;">
                                            ${event.justification}
                                        </div>
                                    </div>` : ''}
                                
                                <!-- Event Categories -->
                                ${event.category_tags && event.category_tags.length > 0 ? `
                                    <div style="margin-bottom: 12px;">
                                        <strong style="color: #495057; font-size: 12px; text-transform: uppercase;">Categories</strong>
                                        <div style="margin-top: 8px; display: flex; flex-wrap: wrap; gap: 6px;">
                                            ${event.category_tags.map(tag => `
                                                <span style="display: inline-block; padding: 4px 10px; background: #e3f2fd; border-radius: 12px; font-size: 11px; color: #0066cc;">
                                                    ${tag}
                                                </span>
                                            `).join('')}
                                        </div>
                                    </div>` : ''}
                                
                                <!-- Source Link -->
                                ${event.event_url ? `
                                    <div style="margin-top: 12px; padding-top: 12px; border-top: 1px solid #dee2e6;">
                                        <a href="${event.event_url}" target="_blank" onclick="event.stopPropagation()" 
                                           style="color: #4facfe; text-decoration: none; font-size: 13px; font-weight: 500;">
                                            🔗 View Event Source →
                                        </a>
                                    </div>` : ''}
                            </div>
                        </div>
                    `;
                }).join('');
            }
            
            // Display pagination
            displayActorPagination(totalPages);
        }
        
        // Display pagination controls
        function displayActorPagination(totalPages) {
            const container = document.getElementById('actor-pagination');
            
            if (totalPages <= 1) {
                container.innerHTML = '';
                return;
            }
            
            let html = '';
            
            // Previous button
            html += `<button onclick="changeActorPage(${actorModalPage - 1})" ${actorModalPage === 1 ? 'disabled' : ''}>Previous</button>`;
            
            // Page numbers
            const maxButtons = 5;
            let startPage = Math.max(1, actorModalPage - Math.floor(maxButtons / 2));
            let endPage = Math.min(totalPages, startPage + maxButtons - 1);
            
            if (endPage - startPage < maxButtons - 1) {
                startPage = Math.max(1, endPage - maxButtons + 1);
            }
            
            for (let i = startPage; i <= endPage; i++) {
                html += `<button onclick="changeActorPage(${i})" class="${i === actorModalPage ? 'active' : ''}">${i}</button>`;
            }
            
            // Next button
            html += `<button onclick="changeActorPage(${actorModalPage + 1})" ${actorModalPage === totalPages ? 'disabled' : ''}>Next</button>`;
            
            container.innerHTML = html;
        }

const _displayActorEventsOriginal = displayActorEvents;
        window.displayActorEvents = function() {
            let events = [...currentActorEvents];

            if (actorEventSearchTerm) {
                const term = actorEventSearchTerm.toLowerCase();
                events = events.filter(e =>
                    (e.v2_events?.event_name || '').toLowerCase().includes(term) ||
                    (e.v2_events?.city || '').toLowerCase().includes(term) ||
                    (e.v2_events?.state || '').toLowerCase().includes(term)
                );
            }

            if (activeStateFilter) {
                events = events.filter(e => (e.v2_events?.state || '') === activeStateFilter);
            }

            currentFilteredActorEvents = events;
            _displayActorEventsOriginal();
        };

        function buildCoverageGrid(events){
            const el = document.getElementById('coverage-grid');
            const counts = {};
            for (const e of events){
                const st = e.v2_events?.state;
                if (st) counts[st] = (counts[st] || 0) + 1;
            }
            const items = Object.entries(counts)
                .sort((a,b) => b[1]-a[1] || a[0].localeCompare(b[0]))
                .map(([state, count]) => `
      <button class="state-chip ${activeStateFilter===state?'active':''}" data-state="${state}">
        <span class="code">${state}</span>
        <span class="count">${count}</span>
      </button>
    `).join('');
            el.innerHTML = items;
            const section = document.getElementById('actor-coverage-section');
            if(section) section.style.display = items ? 'block' : 'none';
            el.querySelectorAll('.state-chip').forEach(btn=>{
                btn.addEventListener('click', ()=>{
                    const st = btn.dataset.state;
                    activeStateFilter = (activeStateFilter===st) ? null : st;
                    buildCoverageGrid(currentActorEvents);
                    displayActorEvents();
                });
            });
        }

        // Change page
        function changeActorPage(page) {
            actorModalPage = page;
            displayActorEvents();
        }
        
        // Change page size
        function changeActorPageSize() {
            const select = document.getElementById('actor-page-size');
            actorModalPageSize = parseInt(select.value);
            actorModalPage = 1;
            displayActorEvents();
        }
        
        // Search events
        function searchActorEvents(event) {
            actorEventSearchTerm = event.target.value;
            actorModalPage = 1;
            displayActorEvents();
        }

        function toggleEventsCompact() {
            const list = document.getElementById('actor-events');
            list.classList.toggle('compact');
        }

        // Toggle export menu
        function toggleActorExportMenu(event) {
            event.stopPropagation();
            const menu = document.getElementById('actor-export-menu');
            menu.style.display = menu.style.display === 'none' ? 'block' : 'none';
        }

        function toCSV(rows) {
            const escape = v => {
                if (v === null || v === undefined) return '';
                const s = String(v).replace(/"/g, '""');
                return /[",\n]/.test(s) ? `"${s}"` : s;
            };
            const headers = Object.keys(rows[0] || {});
            const lines = [
                headers.join(','),
                ...rows.map(r => headers.map(h => escape(r[h])).join(','))
            ];
            return lines.join('\n');
        }

        function downloadCSV(filename, csv) {
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url; a.download = filename;
            document.body.appendChild(a); a.click();
            document.body.removeChild(a);
            setTimeout(() => URL.revokeObjectURL(url), 1000);
        }

        window.exportActorEventsCSV = function({ scope }) {
            let events = (scope === 'visible' && window.currentFilteredActorEvents)
                ? window.currentFilteredActorEvents
                : currentActorEvents;

            const rows = events.map(e => {
                const v = e.v2_events || {};
                return {
                    actor_id: currentActorData?.id,
                    actor_name: currentActorData?.name,
                    event_id: v.id,
                    event_name: v.event_name,
                    event_date: v.event_date,
                    city: v.city,
                    state: v.state,
                    latitude: v.latitude,
                    longitude: v.longitude,
                    event_type: v.event_type,
                    category_tags: JSON.stringify(v.category_tags || null),
                    source_post_ids: JSON.stringify(v.source_post_ids || null),
                    created_at: v.created_at || null,
                    updated_at: v.updated_at || null
                };
            });

            const csv = toCSV(rows);
            const label = scope === 'visible' ? 'visible' : 'all';
            downloadCSV(`actor_events_${label}.csv`, csv);
        };

        window.exportActorSummaryCSV = function() {
            const events = currentActorEvents;
            const byState = {};
            const byCity = {};
            let first = null, last = null;

            for (const e of events) {
                const v = e.v2_events || {};
                if (v.state) byState[v.state] = (byState[v.state] || 0) + 1;
                if (v.city)  byCity[v.city]   = (byCity[v.city] || 0) + 1;

                if (v.event_date) {
                    const d = new Date(v.event_date);
                    first = (!first || d < first) ? d : first;
                    last  = (!last  || d > last)  ? d : last;
                }
            }

            const today = new Date();
            const ninetyAgo = new Date(); ninetyAgo.setDate(today.getDate() - 90);
            const last90 = events.filter(e => {
                const d = e.v2_events?.event_date ? new Date(e.v2_events.event_date) : null;
                return d && d >= ninetyAgo && d <= today;
            }).length;

            const row = {
                actor_id: currentActorData?.id,
                actor_name: currentActorData?.name,
                total_events: events.length,
                events_90d: last90,
                cities: Object.keys(byCity).length,
                states: Object.keys(byState).length,
                first_event: first ? first.toISOString().slice(0,10) : '',
                last_event:  last ?  last.toISOString().slice(0,10) : '',
                years_active: first ? (today.getFullYear() - first.getFullYear() + 1) : '',
                coverage_states: JSON.stringify(byState),
                coverage_cities: JSON.stringify(byCity)
            };

            const csv = toCSV([row]);
            downloadCSV(`actor_summary.csv`, csv);
        };

        window.exportActorMembersCSV = function() {
            const list = (window.filteredActorMembers?.length ? filteredActorMembers : currentActorMembers) || [];
            const rows = list.map(m => ({
                actor_id: currentActorData?.id,
                organization: currentActorData?.name,
                person_id: m.person_id || m.id,
                person_name: m.full_name || m.name,
                relationship: (m.relationship || m.relationship_type || '').toLowerCase(),
                role: m.role || '',
                role_category: m.role_category || '',
                city: m.city || '',
                state: m.state || '',
                start_date: m.start_date || '',
                end_date: m.end_date || ''
            }));
            const csv = toCSV(rows);
            downloadCSV(`members_visible.csv`, csv);
        };
        
        // Fetch organization members
        async function fetchOrganizationMembers(orgId) {
            try {
                console.log('Fetching members for organization:', orgId);
                
                // Fetch all actor links where to_actor_id is the organization
                // This gets all people who point TO this organization
                // Include the full actor information for the FROM actors (the people)
                const members = await supabaseRequest(
                    `v2_actor_links?select=*,from_actor:v2_actors!actor_links_from_actor_id_fkey(*)&to_actor_id=eq.${orgId}&order=role.asc.nullslast`
                );
                
                console.log(`Found ${members.length} member links for organization`);
                console.log('Sample member data:', members[0]); // Debug log
                
                // Filter to only show person types with valid actor data
                currentActorMembers = members.filter(m => {
                    // Make sure we have valid from_actor data
                    if (!m.from_actor || !m.from_actor.id) {
                        console.warn('Member link missing from_actor data:', m);
                        return false;
                    }
                    return m.from_actor.actor_type === 'person';
                });
                
                console.log(`Filtered to ${currentActorMembers.length} valid person members`);
                document.getElementById('actor-members-count').textContent = `(${currentActorMembers.length})`;
                
                // Display the members
                displayOrganizationMembers();
                
            } catch (error) {
                console.error('Error fetching organization members:', error);
                document.getElementById('actor-members-list').innerHTML = 
                    '<div style="color: #dc3545; padding: 20px;">Error loading members</div>';
            }
        }
        
        // Display organization members
        function displayOrganizationMembers() {
            const searchTerm = document.getElementById('members-search')?.value?.toLowerCase() || '';
            const filterType = document.getElementById('members-filter')?.value?.toLowerCase() || '';
            
            // Filter members
            filteredActorMembers = currentActorMembers.filter(member => {
                // Extra safety check
                if (!member.from_actor) return false;
                
                // Search filter
                const matchesSearch = !searchTerm || 
                    member.from_actor.name?.toLowerCase().includes(searchTerm) ||
                    member.role?.toLowerCase().includes(searchTerm) ||
                    member.role_category?.toLowerCase().includes(searchTerm) ||
                    member.relationship?.toLowerCase().includes(searchTerm);
                
                // Relationship type filter
                const matchesFilter = !filterType || 
                    member.relationship?.toLowerCase().includes(filterType);
                
                return matchesSearch && matchesFilter;
            });
            
            const container = document.getElementById('actor-members-list');
            
            if (filteredActorMembers.length === 0) {
                container.innerHTML = '<div style="text-align: center; color: #666; padding: 20px;">No members found</div>';
                return;
            }
            
            // Create table
            const tableHtml = `
                <table style="width: 100%; border-collapse: collapse; font-size: 13px;">
                    <thead>
                        <tr style="background: #f8f9fa; border-bottom: 2px solid #dee2e6;">
                            <th style="padding: 10px; text-align: left;">Name</th>
                            <th style="padding: 10px; text-align: left;">Relationship</th>
                            <th style="padding: 10px; text-align: left;">Role</th>
                            <th style="padding: 10px; text-align: left;">Role Category</th>
                            <th style="padding: 10px; text-align: left;">Location</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${filteredActorMembers.map(member => {
                            // Safety check for from_actor
                            if (!member.from_actor || !member.from_actor.id) {
                                console.warn('Skipping member with invalid from_actor:', member);
                                return '';
                            }
                            return `
                            <tr class="member-row" onclick="showDetails('${member.from_actor.id}')" 
                                style="cursor: pointer; border-bottom: 1px solid #e9ecef; transition: background 0.2s;"
                                onmouseover="this.style.background='#f8f9fa'" 
                                onmouseout="this.style.background='white'">
                                <td style="padding: 10px; font-weight: 500; color: #333;">
                                    ${member.from_actor.name || 'Unknown'}
                                </td>
                                <td style="padding: 10px; color: #666;">
                                    <span style="padding: 2px 8px; background: #e3f2fd; border-radius: 12px; font-size: 11px;">
                                        ${member.relationship || 'Related'}
                                    </span>
                                </td>
                                <td style="padding: 10px; color: #666;">
                                    ${member.role || '-'}
                                </td>
                                <td style="padding: 10px; color: #666;">
                                    ${member.role_category || '-'}
                                </td>
                                <td style="padding: 10px; color: #666;">
                                    ${[member.from_actor.city, member.from_actor.state].filter(Boolean).join(', ') || '-'}
                                </td>
                            </tr>
                        `;
                        }).join('')}
                    </tbody>
                </table>
            `;
            
            container.innerHTML = tableHtml;
        }
        
        // Filter organization members
        function filterOrganizationMembers() {
            displayOrganizationMembers();
        }
        
        // Toggle event details
        function toggleEventDetails(eventId) {
            console.log('toggleEventDetails called for:', eventId);
            
            // Prevent event bubbling
            if (window.event) {
                window.event.stopPropagation();
            }
            
            const detailsDiv = document.getElementById(`${eventId}-details`);
            const eventDiv = document.getElementById(eventId);
            
            console.log('Found elements:', {
                detailsDiv: !!detailsDiv,
                eventDiv: !!eventDiv,
                currentDisplay: detailsDiv?.style.display
            });
            
            if (detailsDiv) {
                // Toggle display
                if (detailsDiv.style.display === 'none' || detailsDiv.style.display === '') {
                    detailsDiv.style.display = 'block';
                    console.log('Expanded event details');
                    if (eventDiv) {
                        eventDiv.classList.add('expanded');
                        const eventUuid = eventDiv.getAttribute('data-event-id');
                        const postsContainer = document.getElementById(`${eventId}-posts-container`);
                        if (eventUuid && postsContainer && postsContainer.innerHTML.trim() === '') {
                            loadEventPosts(eventUuid, eventId);
                        }
                    }
                } else {
                    detailsDiv.style.display = 'none';
                    console.log('Collapsed event details');
                    if (eventDiv) {
                        eventDiv.classList.remove('expanded');
                    }
                }
            } else {
                console.error('Details div not found for:', `${eventId}-details`);
                // Log all event elements for debugging
                console.log('Available event elements:',
                    Array.from(document.querySelectorAll('[id^="actor-event-"]')).map(el => el.id)
                );
            }
        }
        
        // Update back button text based on navigation history
        async function updateBackButton() {
            const backBtn = document.querySelector('.btn-back');
            if (!backBtn) return;
            
            if (actorNavigationHistory.length > 0) {
                // Try to get the name of the previous actor
                try {
                    const previousActorId = actorNavigationHistory[actorNavigationHistory.length - 1];
                    const [previousActor] = await supabaseRequest(`v2_actors?select=name&id=eq.${previousActorId}`);
                    if (previousActor && previousActor.name) {
                        backBtn.textContent = `← Back to ${previousActor.name}`;
                    } else {
                        backBtn.textContent = '← Back';
                    }
                } catch (err) {
                    backBtn.textContent = '← Back';
                }
            } else {
                backBtn.textContent = '← Back';
            }
        }
        
        // Close Actor Detail Modal or go back to previous actor
        function closeActorDetail() {
            // If we have navigation history, go back to the previous actor
            if (actorNavigationHistory.length > 0) {
                const previousActorId = actorNavigationHistory.pop();
                console.log('Going back to actor:', previousActorId);
                showDetails(previousActorId, false); // false = don't push to history
            } else {
                // No history, close the modal
                const modal = document.getElementById('actor-detail-modal');
                if (modal) {
                    modal.style.display = 'none';
                }
                // Clear everything when closing
                actorNavigationHistory = [];
                currentActorData = null;
                currentActorEvents = [];
                currentActorMembers = [];
                filteredActorMembers = [];
                actorModalPage = 1;
                actorEventSearchTerm = '';
            }
        }
        
        // Close modal when clicking outside
        window.onclick = function(event) {
            const modal = document.getElementById('detail-modal');
            if (event.target === modal) {
                closeModal();
            }
        }
    </script>
    <!-- Twitter Widget Script for Embedded Tweets -->
    <script async src="https://platform.twitter.com/widgets.js" charset="utf-8"></script>
</body>
</html>